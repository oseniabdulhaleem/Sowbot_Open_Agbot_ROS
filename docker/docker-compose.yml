version: '3.8'

services:
  agbot:
    image: openagbot:dev
    container_name: openagbot_app
    network_mode: host
    privileged: true
    # Resource limits to prevent "GPS Unplugged" loops from freezing the ThinkPad
    deploy:
      resources:
        limits:
          cpus: '1.5'  # 150% of a single core (75% of total dual-core capacity)
    
    # Loads hardware assignments from .env
    env_file:
      - .env
    
    volumes:
      - /dev:/dev
      - ..:/workspace  # Maps the main open_agbot_ws directory into the container
    
    environment:
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - MONGO_HOST=localhost
      - GPS_PORT=${GPS_PORT}
      - MCU_PORT=${MCU_PORT}
    
    # Logic: Start DB Store -> Wait for connection -> Launch Hardware or Virtual Driver
    command: >
      bash -c "source /workspace/install/setup.bash && 
      echo 'üöÄ Starting MongoDB Store...' &&
      ros2 launch mongodb_store mongodb_store.launch.py & 
      sleep 7;
      if [ \"$$GPS_PORT\" != \"virtual\" ]; then 
        echo 'üõ∞Ô∏è Hardware Mode: GPS=$$GPS_PORT, MCU=$$MCU_PORT' &&
        ros2 launch basekit_launch basekit_launch.py gps_port:=$$GPS_PORT mcu_port:=$$MCU_PORT; 
      else 
        echo 'üíª Virtual Mode: Launching UI and Driver Node' &&
        ros2 run basekit_driver basekit_driver_node --ros-args -r __node:=controller -p use_sim_time:=true & 
        ros2 run basekit_ui basekit_ui_node; 
      fi"
    
    depends_on:
      - mongodb

  # Database for Topological Navigation (aoc branch)
  mongodb:
    image: mongo:6.0
    container_name: agbot_db
    network_mode: host
    volumes:
      - mongodb_data:/data/db
    restart: always

volumes:
  mongodb_data:
